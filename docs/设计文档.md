# 终端安全监控系统 - Phase 2 设计文档

## 版本信息

| 项目 | 内容 |
|------|------|
| 版本号 | v1.0.0 |
| 文档版本 | 2.0 |
| 创建日期 | 2026-02-11 |
| 状态 | 已完成 |

---

## 1. 系统架构

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Vue 3)                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ 基线管理    │  │ 告警中心     │  │ Dashboard   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└────────────────────────────┬────────────────────────────────────┘
                             │ REST API
┌────────────────────────────┼────────────────────────────────────┐
│                     后端 (SpringBoot)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ 基线服务    │  │ 告警服务     │  │ 异常检测    │            │
│  │ BaselineSvc │  │ AlertSvc    │  │ Detector    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│  ┌─────────────┐  ┌─────────────┐                              │
│  │ 控制器      │  │ 仓储层      │                              │
│  └─────────────┘  └─────────────┘                              │
└────────────────────────────┬────────────────────────────────────┘
                             │ JPA
┌────────────────────────────┼────────────────────────────────────┐
│                     数据库 (MySQL)                              │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │
┌────────────────────────────┼────────────────────────────────────┐
│                     Agent (Python)                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ 数据采集器   │  │ 心跳上报    │  │ WebSocket   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 核心模块

```
┌────────────────────────────────────────────────────────────┐
│                    行为基线模块                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ 学习模式管理  │  │ 快照管理     │  │ 对比引擎    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────┐
│                    异常检测模块                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ 进程异常检测  │  │ 端口异常检测 │  │ 登录异常检测│   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐                      │
│  │ USB异常检测   │  │ 软件异常检测 │                      │
│  └──────────────┘  └──────────────┘                      │
└────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────┐
│                    告警管理模块                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ 告警生成     │  │ 告警处理     │  │ 规则引擎    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└────────────────────────────────────────────────────────────┘
```

---

## 2. 类设计

### 2.1 基线相关类

#### 2.1.1 BaselineConfig（基线配置）

```java
@Entity
@Table(name = "baseline_config")
public class BaselineConfig {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "agent_id", nullable = false, length = 36)
    private String agentId;

    @Column(name = "baseline_type", nullable = false, length = 20)
    private String baselineType;

    @Column(name = "status", length = 20)
    private String status;  // LEARNING, ACTIVE

    @Column(name = "learning_mode", length = 20)
    private String learningMode;  // QUICK, STANDARD, CUSTOM, MANUAL

    @Column(name = "learning_days")
    private Integer learningDays;

    @Column(name = "learn_start")
    private LocalDateTime learnStart;

    @Column(name = "learn_end")
    private LocalDateTime learnEnd;

    @Column(name = "created_type", length = 20)
    private String createdType;  // LEARNING, IMPORT, COPY, MANUAL

    @Column(name = "source_agent_id", length = 36)
    private String sourceAgentId;
}
```

#### 2.1.2 BaselineSnapshot（基线快照）

```java
@Entity
@Table(name = "baseline_snapshot")
public class BaselineSnapshot {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "agent_id", nullable = false, length = 36)
    private String agentId;

    @Column(name = "baseline_type", nullable = false, length = 20)
    private String baselineType;

    @Column(name = "config_id")
    private Long configId;

    @Column(name = "snapshot_hash", length = 64)
    private String snapshotHash;

    @Column(name = "item_count")
    private Integer itemCount;

    @Column(name = "valid_from")
    private LocalDateTime validFrom;

    @Column(name = "created_at")
    private LocalDateTime createdAt;
}
```

#### 2.1.3 BaselineItem（基线项目）

```java
@Entity
@Table(name = "baseline_item")
public class BaselineItem {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "snapshot_id")
    private Long snapshotId;

    @Column(name = "item_key", nullable = false, length = 255)
    private String itemKey;

    @Column(name = "item_value", columnDefinition = "TEXT")
    private String itemValue;

    @Column(name = "item_type", length = 50)
    private String itemType;

    @Column(name = "item_hash", length = 64)
    private String itemHash;
}
```

### 2.2 告警相关类

#### 2.2.1 SecurityAlert（安全告警）

```java
@Entity
@Table(name = "security_alert")
public class SecurityAlert {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "agent_id", nullable = false, length = 36)
    private String agentId;

    @Column(name = "alert_type", nullable = false, length = 50)
    private String alertType;

    @Column(name = "alert_level", nullable = false, length = 20)
    private String alertLevel;  // CRITICAL, HIGH, MEDIUM, LOW

    @Column(name = "alert_title", nullable = false, length = 200)
    private String alertTitle;

    @Column(name = "alert_content", columnDefinition = "TEXT")
    private String alertContent;

    @Column(name = "anomaly_type", length = 50)
    private String anomalyType;  // NEW, MISSING, MODIFIED

    @Column(name = "baseline_item", columnDefinition = "JSON")
    private String baselineItem;

    @Column(name = "current_item", columnDefinition = "JSON")
    private String currentItem;

    @Column(name = "alert_status", length = 20)
    private String alertStatus;  // NEW, ACKNOWLEDGED, RESOLVED, IGNORED

    @Column(name = "acknowledged_by", length = 100)
    private String acknowledgedBy;

    @Column(name = "acknowledged_at")
    private LocalDateTime acknowledgedAt;

    @Column(name = "resolved_by", length = 100)
    private String resolvedBy;

    @Column(name = "resolved_at")
    private LocalDateTime resolvedAt;

    @Column(name = "resolution_note", columnDefinition = "TEXT")
    private String resolutionNote;

    @Column(name = "ignored_by", length = 100)
    private String ignoredBy;

    @Column(name = "ignored_at")
    private LocalDateTime ignoredAt;

    @Column(name = "ignore_reason", columnDefinition = "TEXT")
    private String ignoreReason;

    @Column(name = "created_at")
    private LocalDateTime createdAt;
}
```

#### 2.2.2 AlertRule（告警规则）

```java
@Entity
@Table(name = "alert_rule")
public class AlertRule {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "rule_name", nullable = false, length = 100)
    private String ruleName;

    @Column(name = "rule_type", nullable = false, length = 50)
    private String ruleType;

    @Column(name = "rule_condition", nullable = false, length = 500)
    private String ruleCondition;

    @Column(name = "action_type", length = 50)
    private String actionType;

    @Column(name = "alert_level", length = 20)
    private String alertLevel;

    @Column(nullable = false)
    private Boolean enabled;

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
}
```

### 2.3 DTO类

#### 2.3.1 BaselineCompareResult（基线对比结果）

```java
public class BaselineCompareResult {
    private String baselineType;
    private int newItemsCount;
    private int missingItemsCount;
    private int modifiedItemsCount;
    private List<AnomalyDTO> newItems;
    private List<AnomalyDTO> missingItems;
    private List<AnomalyDTO> modifiedItems;
}
```

#### 2.3.2 AnomalyDTO（异常数据传输对象）

```java
public class AnomalyDTO {
    private String anomalyType;  // NEW, MISSING, MODIFIED
    private String itemKey;
    private String alertLevel;
    private Map<String, Object> baselineValue;
    private Map<String, Object> currentValue;
}
```

---

## 3. 服务设计

### 3.1 BaselineService

```java
@Service
public class BaselineService {

    // 学习模式
    public BaselineConfig startQuickLearn(String agentId, String type);
    public BaselineConfig startStandardLearn(String agentId, String type);
    public BaselineConfig startCustomLearn(String agentId, String type, int days);

    // 创建方式
    public BaselineConfig importFromCurrent(String agentId, String type);
    public BaselineConfig copyFromAgent(String sourceAgentId, String targetAgentId, String type);
    public BaselineConfig manualCreate(String agentId, String type, List<BaselineItemDTO> items);

    // 查询方法
    public List<BaselineConfig> getBaselineConfigs(String agentId);
    public Optional<BaselineConfig> getBaselineConfig(String agentId, String type);
    public List<BaselineSnapshot> getSnapshots(String agentId, String type);
    public List<BaselineItem> getBaselineItems(String agentId, String type);

    // 对比功能
    public BaselineCompareResult compareWithBaseline(String agentId, String type);

    // 删除
    public void deleteBaseline(String agentId, String type);
}
```

### 3.2 AlertService

```java
@Service
public class AlertService {

    // 告警操作
    public SecurityAlert createAlert(String agentId, String alertType,
        String alertLevel, String alertTitle, String alertContent);
    public List<SecurityAlert> getAllAlerts();
    public List<SecurityAlert> getAlertsByStatus(String status);
    public Optional<SecurityAlert> getAlertById(Long id);

    // 告警处理
    public SecurityAlert acknowledgeAlert(Long alertId, String acknowledgedBy);
    public SecurityAlert resolveAlert(Long alertId, String resolvedBy, String resolutionNote);
    public SecurityAlert ignoreAlert(Long alertId, String ignoredBy, String ignoreReason);

    // 统计
    public AlertStats getAlertStats();
    public long countNewAlerts();
    public long countCriticalUnresolved();

    // 规则管理
    public AlertRule createRule(String ruleType, String ruleName, String ruleCondition,
        String alertLevel, String actionType, boolean enabled);
    public List<AlertRule> getAllRules();
    public List<AlertRule> getEnabledRules();
    public AlertRule toggleRule(Long ruleId, boolean enabled);
    public void deleteRule(Long ruleId);
}
```

---

## 4. API设计

### 4.1 基线管理API

#### 4.1.1 获取Agent基线配置列表

```
GET /api/baselines/{agentId}

Response:
[
  {
    "id": 1,
    "agentId": "xxx",
    "baselineType": "PROCESS",
    "status": "ACTIVE",
    "learningMode": "STANDARD",
    "learningDays": 7
  }
]
```

#### 4.1.2 启动快速学习

```
POST /api/baselines/{agentId}/{type}/quick-learn

Response:
{
  "id": 1,
  "agentId": "xxx",
  "baselineType": "PROCESS",
  "status": "LEARNING",
  "learningMode": "QUICK",
  "learningDays": 0
}
```

#### 4.1.3 启动标准学习

```
POST /api/baselines/{agentId}/{type}/standard-learn
```

#### 4.1.4 启动自定义学习

```
POST /api/baselines/{agentId}/{type}/custom-learn
Body: { "days": 14 }

Response:
{
  "id": 1,
  "status": "LEARNING",
  "learningMode": "CUSTOM",
  "learningDays": 14
}
```

#### 4.1.5 导入当前数据

```
POST /api/baselines/{agentId}/{type}/import
```

#### 4.1.6 复制基线

```
POST /api/baselines/{agentId}/{type}/copy
Body: { "sourceAgentId": "yyy" }
```

#### 4.1.7 手动创建基线

```
POST /api/baselines/{agentId}/{type}/manual
Body: [
  { "itemKey": "nginx:1234", "itemValue": "80", "itemType": "port" }
]
```

#### 4.1.8 获取快照列表

```
GET /api/baselines/{agentId}/{type}/snapshots
```

#### 4.1.9 获取基线项目

```
GET /api/baselines/{agentId}/{type}/items
```

#### 4.1.10 对比基线

```
GET /api/baselines/{agentId}/{type}/compare

Response:
{
  "baselineType": "PROCESS",
  "newItemsCount": 2,
  "missingItemsCount": 1,
  "modifiedItemsCount": 0,
  "newItems": [
    {
      "anomalyType": "NEW",
      "itemKey": "suspicious:9999",
      "alertLevel": "MEDIUM"
    }
  ],
  "missingItems": [...],
  "modifiedItems": [...]
}
```

#### 4.1.11 删除基线

```
DELETE /api/baselines/{agentId}/{type}
```

### 4.2 告警管理API

#### 4.2.1 获取所有告警

```
GET /api/alerts

Response:
[
  {
    "id": 1,
    "agentId": "xxx",
    "alertType": "PROCESS",
    "alertLevel": "HIGH",
    "alertTitle": "发现未知进程",
    "alertStatus": "NEW",
    "createdAt": "2026-02-11T12:00:00"
  }
]
```

#### 4.2.2 获取告警统计

```
GET /api/alerts/stats

Response:
{
  "totalNew": 5,
  "totalAcknowledged": 3,
  "totalResolved": 10,
  "totalIgnored": 2,
  "criticalUnresolved": 1,
  "totalAlerts": 20
}
```

#### 4.2.3 获取单个告警

```
GET /api/alerts/{id}
```

#### 4.2.4 确认告警

```
POST /api/alerts/{id}/acknowledge
Body: { "acknowledgedBy": "admin" }

Response:
{
  "id": 1,
  "alertStatus": "ACKNOWLEDGED",
  "acknowledgedAt": "2026-02-11T12:05:00",
  "acknowledgedBy": "admin"
}
```

#### 4.2.5 解决告警

```
POST /api/alerts/{id}/resolve
Body: { "resolvedBy": "admin", "resolutionNote": "已清除恶意进程" }

Response:
{
  "id": 1,
  "alertStatus": "RESOLVED",
  "resolvedAt": "2026-02-11T12:10:00",
  "resolvedBy": "admin",
  "resolutionNote": "已清除恶意进程"
}
```

#### 4.2.6 忽略告警

```
POST /api/alerts/{id}/ignore
Body: { "ignoredBy": "admin", "reason": "误报" }

Response:
{
  "id": 1,
  "alertStatus": "IGNORED",
  "ignoredAt": "2026-02-11T12:15:00",
  "ignoredBy": "admin",
  "ignoreReason": "误报"
}
```

#### 4.2.7 获取告警规则列表

```
GET /api/alerts/rules
```

#### 4.2.8 创建告警规则

```
POST /api/alerts/rules
Body: {
  "ruleType": "PORT",
  "ruleName": "检测高危端口",
  "ruleCondition": "port >= 8000 && port <= 9000",
  "alertLevel": "HIGH",
  "actionType": "ALERT",
  "enabled": true
}
```

#### 4.2.9 切换规则状态

```
PUT /api/alerts/rules/{id}/toggle
Body: { "enabled": false }
```

---

## 5. 异常检测算法

### 5.1 基线对比算法

```java
public BaselineCompareResult compareWithBaseline(String agentId, String type) {
    // 1. 获取当前数据
    List<Map<String, Object>> currentData = getCurrentData(agentId, type);

    // 2. 获取基线项目
    List<BaselineItem> baselineItems = getBaselineItems(agentId, type);

    // 3. 构建基线Map
    Map<String, BaselineItem> baselineMap = baselineItems.stream()
        .collect(Collectors.toMap(BaselineItem::getItemKey, i -> i));

    // 4. 检测新增项目
    List<AnomalyDTO> newItems = currentData.stream()
        .filter(current -> !baselineMap.containsKey(current.get("itemKey")))
        .map(current -> createAnomaly("NEW", current))
        .collect(Collectors.toList());

    // 5. 检测缺失项目
    List<AnomalyDTO> missingItems = baselineItems.stream()
        .filter(baseline -> !currentData.stream()
            .anyMatch(c -> c.get("itemKey").equals(baseline.getItemKey())))
        .map(baseline -> createAnomaly("MISSING", baseline))
        .collect(Collectors.toList());

    // 6. 检测修改项目
    List<AnomalyDTO> modifiedItems = currentData.stream()
        .filter(current -> {
            BaselineItem baseline = baselineMap.get(current.get("itemKey"));
            return baseline != null && !Objects.equals(
                current.get("itemValue"), baseline.getItemValue());
        })
        .map(current -> createAnomaly("MODIFIED", current))
        .collect(Collectors.toList());

    return buildResult(type, newItems, missingItems, modifiedItems);
}
```

### 5.2 告警级别判定

| 异常类型 | 告警级别规则 |
|----------|--------------|
| NEW | MEDIUM（进程）、HIGH（端口） |
| MISSING | LOW |
| MODIFIED | LOW |

---

## 6. 前端组件设计

### 6.1 页面结构

```
views/
├── Dashboard.vue              # 仪表盘
├── AgentList.vue              # Agent列表
├── AgentDetail.vue            # Agent详情
├── BaselineManager.vue        # 基线管理（主页面）
└── AlertCenter.vue            # 告警中心

components/
└── BaselineTypePanel.vue      # 单类型基线面板
```

### 6.2 API模块

```
api/
├── index.js                   # Axios配置 + Agent API
├── baseline.js               # 基线管理API
└── alert.js                  # 告警管理API
```

### 6.3 路由配置

```javascript
{
  path: '/baselines',
  name: 'BaselineManager',
  component: () => import('../views/BaselineManager.vue')
},
{
  path: '/alerts',
  name: 'AlertCenter',
  component: () => import('../views/AlertCenter.vue')
}
```

---

## 7. 安全设计

### 7.1 认证机制

- Agent注册时分配唯一ID
- 所有API请求携带Agent ID
- 建议生产环境添加Token认证

### 7.2 数据验证

- 所有输入参数进行校验
- 防止SQL注入
- 防止XSS攻击

### 7.3 审计日志

- 记录所有管理操作
- 记录告警状态变更
- 保留日志90天

---

## 8. 性能优化

### 8.1 数据库优化

- 常用查询字段建立索引
- 分页查询限制单页数量
- 定期清理历史数据

### 8.2 缓存策略

- 启用Spring Cache
- 基线配置缓存
- 告警统计缓存

### 8.3 异步处理

- 告警生成异步处理
- 大量数据导入异步处理
- 邮件/短信通知异步发送

---

## 9. 扩展性设计

### 9.1 新增基线类型

1. 在枚举类中添加新类型
2. 创建对应的Repository
3. 实现数据采集逻辑
4. 添加检测规则

### 9.2 新增告警级别

1. 修改SecurityAlert实体
2. 修改前端组件
3. 更新验证规则

### 9.3 集成外部系统

- 邮件通知：扩展AlertService
- 短信通知：扩展AlertService
- SIEM集成：添加导出接口
