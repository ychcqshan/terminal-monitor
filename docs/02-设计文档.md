# 终端安全监控系统 - 完整设计文档

## 版本信息

| 项目 | 内容 |
|------|------|
| 版本号 | v1.0.0 |
| 文档版本 | 3.0 |
| 创建日期 | 2026-02-11 |
| 状态 | 正式发布 |

---

## 目录

1. [系统架构设计](#1-系统架构设计)
2. [Agent设计](#2-agent设计)
3. [后端设计](#3-后端设计)
4. [前端设计](#4-前端设计)
5. [数据库设计](#5-数据库设计)
6. [API设计](#6-api设计)
7. [安全设计](#7-安全设计)
8. [部署架构](#8-部署架构)

---

## 1. 系统架构设计

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Web 前端 (Vue 3 + Element Plus)                  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                        Vue Router 路由管理                          │  │
│  │   /dashboard  /agents  /agents/:id  /baselines  /alerts            │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                        Pinia 状态管理                             │  │
│  │      AgentStore / BaselineStore / AlertStore / ConfigStore        │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                        API 层                                      │  │
│  │      agentApi / baselineApi / alertApi / healthApi                │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Axios / REST API
┌───────────────────────────────────────────────────────────────────────────┐
│                        后端服务 (SpringBoot 3.2 + Java 17)                 │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                     Controller Layer                               │  │
│  │   AgentController / BaselineController / AlertController         │  │
│  │   HealthController                                              │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                     Service Layer                                  │  │
│  │   AgentService / HostInfoService / BaselineService               │  │
│  │   AlertService / 各数据采集Service                                 │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    Repository Layer                                │  │
│  │   JPA Repositories (AgentRepository / BaselineRepository 等)     │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ JPA / MySQL
┌───────────────────────────────────────────────────────────────────────────┐
│                           数据库层 (MySQL 8.0)                              │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐   │
│  │  agents   │ │ processes │ │   ports   │ │ host_info │ │usb_devices│   │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘   │
│  ┌───────────┐ ┌─────────────────┐ ┌───────────────┐ ┌──────────────┐   │
│  │login_logs │ │ baseline_config │ │baseline_item  │ │security_alert│   │
│  └───────────┘ └─────────────────┘ └───────────────┘ └──────────────┘   │
└───────────────────────────────────────────────────────────────────────────┘
                              ▲
                              │ HTTPS REST API
┌───────────────────────────────────────────────────────────────────────────┐
│                         Agent (Python 3.8+)                                │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                      Main Application                              │  │
│  │                    TerminalMonitorAgent                            │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────────┐  │
│  │   Collectors      │ │   Storage         │ │      Reporter          │  │
│  │  - Process        │ │  - SQLite DB      │ │  - DataReporter       │  │
│  │  - Port           │ │  - Data Queue     │ │  - Heartbeat          │  │
│  │  - System         │ │  - Offline Cache  │ │  - Retry Mechanism    │  │
│  │  - Network        │ └───────────────────┘ └───────────────────────┘  │
│  │  - Software       │                                                 │
│  │  - USB            │                                                 │
│  │  - Login          │                                                 │
│  └───────────────────┘                                                 │
└───────────────────────────────────────────────────────────────────────────┘
```

### 1.2 模块划分

```
┌─────────────────────────────────────────────────────────────────────┐
│                        终端安全监控系统                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │
│  │  Agent模块   │  │  后端模块    │  │      前端模块            │ │
│  ├──────────────┤  ├──────────────┤  ├──────────────────────────┤ │
│  │ • 数据采集   │  │ • Agent管理  │  │ • Dashboard页面          │ │
│  │ • 心跳上报   │  │ • 数据接收   │  │ • Agent管理页面         │ │
│  │ • 本地存储   │  │ • 基线管理   │  │ • 基线管理页面          │ │
│  │ • 断网重连   │  │ • 告警处理   │  │ • 告警中心页面          │ │
│  │ • 配置管理   │  │ • API服务    │  │ • 详情展示页面          │ │
│  └──────────────┘  └──────────────┘  └──────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.3 技术选型

| 层级 | 技术 | 版本 | 用途 |
|------|------|------|------|
| Agent语言 | Python | 3.8+ | 数据采集、逻辑处理 |
| 后端语言 | Java | 17 | API服务、业务逻辑 |
| 前端框架 | Vue 3 | 3.x | Web界面 |
| UI组件库 | Element Plus | 2.x | UI组件 |
| 构建工具 | Vite | 5.x | 前端构建 |
| 后端框架 | SpringBoot | 3.2 | 后端框架 |
| ORM框架 | Spring Data JPA | 3.x | 数据访问 |
| 数据库 | MySQL | 8.0 | 主数据库 |
| Agent存储 | SQLite | 3.x | 本地缓存 |
| HTTP客户端 | requests | - | Agent网络请求 |
| 系统信息 | psutil | - | 进程/端口采集 |
| HTTP客户端 | Axios | 1.x | 前端网络请求 |

---

## 2. Agent设计

### 2.1 Agent架构

```
TerminalMonitorAgent
│
├── 配置管理
│   ├── load_config()           # 加载配置
│   └── config.json            # 配置文件
│
├── 数据采集器 (Collectors)
│   ├── ProcessCollector       # 进程信息采集
│   ├── PortCollector          # 端口信息采集
│   ├── SystemCollector       # 系统信息采集
│   ├── NetworkCollector      # 网络信息采集
│   ├── SoftwareCollector    # 软件信息采集
│   ├── USBCollector          # USB设备采集
│   └── LoginCollector        # 登录日志采集
│
├── 本地存储 (Storage)
│   ├── AgentDatabase          # SQLite数据库
│   └── Data Queue            # 上报队列
│
├── 数据上报 (Reporter)
│   ├── DataReporter          # 数据上报器
│   ├── Heartbeat             # 心跳发送
│   └── Retry Mechanism       # 重试机制
│
└── 线程管理
    ├── Collect Thread        # 采集线程
    └── Heartbeat Thread      # 心跳线程
```

### 2.2 配置设计

```json
// config.json
{
  "server_url": "http://localhost:8080",
  "agent_id": null,
  "agent_name": null,
  "collect_interval": 60,
  "heartbeat_interval": 30,
  "retry_times": 3,
  "retry_interval": 5,
  "db_path": "./data/agent.db"
}
```

### 2.3 数据采集流程

```python
def _collect_loop(self):
    """数据采集主循环"""
    while self.running:
        try:
            # 采集进程信息
            processes = self.process_collector.collect()
            self.db.save_processes(self.agent_id, processes)
            self.reporter.send_data(self.agent_id, "processes", processes)
            
            # 采集端口信息
            ports = self.port_collector.collect()
            self.db.save_ports(self.agent_id, ports)
            self.reporter.send_data(self.agent_id, "ports", ports)
            
            # 采集系统信息
            system_info = self.system_collector.collect()
            self.reporter.send_data(self.agent_id, "host_info", system_info)
            
            # 等待采集间隔
            time.sleep(self.config.collect_interval)
            
        except Exception as e:
            logger.error(f"采集异常: {e}")
```

### 2.4 心跳上报流程

```python
def _heartbeat_loop(self):
    """心跳发送循环"""
    while self.running:
        try:
            success = self.reporter.send_heartbeat(
                self.agent_id, 
                status="online"
            )
            if success:
                self.db.update_agent_status(self.agent_id, "online")
            else:
                self.db.update_agent_status(self.agent_id, "offline")
        except Exception as e:
            logger.error(f"心跳异常: {e}")
        
        time.sleep(self.config.heartbeat_interval)
```

### 2.5 断网重连机制

```python
def send_data_with_retry(self, agent_id, data_type, data):
    """带重试的数据上报"""
    max_retries = self.config.retry_times
    
    for attempt in range(max_retries):
        try:
            result = self.reporter.send_data(agent_id, data_type, data)
            if result:
                return True
        except ConnectionError:
            # 网络中断，存入队列
            self.db.queue_data(data_type, data)
        
        time.sleep(self.config.retry_interval)
    
    # 所有重试失败，存入队列
    self.db.queue_data(data_type, data)
    return False
```

---

## 3. 后端设计

### 3.1 整体架构

```
SpringBoot Application
│
├── Controllers
│   ├── AgentController        # Agent管理接口
│   ├── BaselineController     # 基线管理接口
│   ├── AlertController        # 告警管理接口
│   └── HealthController       # 健康检查接口
│
├── Services
│   ├── AgentService           # Agent业务逻辑
│   ├── BaselineService        # 基线业务逻辑
│   ├── AlertService           # 告警业务逻辑
│   ├── HostInfoService       # 主机信息业务逻辑
│   ├── InstalledSoftwareService
│   ├── UsbDeviceService
│   └── LoginLogService
│
├── Repositories
│   ├── AgentRepository
│   ├── BaselineConfigRepository
│   ├── BaselineSnapshotRepository
│   ├── BaselineItemRepository
│   ├── SecurityAlertRepository
│   ├── AlertRuleRepository
│   ├── ProcessInfoRepository
│   ├── PortInfoRepository
│   ├── HostInfoRepository
│   ├── UsbDeviceRepository
│   ├── LoginLogRepository
│   └── InstalledSoftwareRepository
│
├── Entities
│   ├── Agent
│   ├── ProcessInfo
│   ├── PortInfo
│   ├── HostInfo
│   ├── BaselineConfig
│   ├── BaselineSnapshot
│   ├── BaselineItem
│   ├── SecurityAlert
│   ├── AlertRule
│   ├── UsbDevice
│   ├── LoginLog
│   └── InstalledSoftware
│
└── DTOs
    ├── BaselineCompareResult
    ├── AnomalyDTO
    └── AlertStats
```

### 3.2 核心实体关系

```
Agent (1) ────── (N) ProcessInfo
   │
   ├── (1) ────── (N) PortInfo
   │
   ├── (1) ────── (N) HostInfo
   │
   ├── (1) ────── (N) UsbDevice
   │
   ├── (1) ────── (N) LoginLog
   │
   ├── (1) ────── (N) InstalledSoftware
   │
   ├── (1) ────── (N) BaselineConfig ──── (1) BaselineSnapshot
   │                                                      │
   │                                              (1) ─── (N) BaselineItem
   │
   └── (1) ────── (N) SecurityAlert
```

### 3.3 Service设计

#### 3.3.1 AgentService

```java
@Service
@Transactional
public class AgentService {
    
    public Agent registerOrUpdateAgent(Map<String, String> agentInfo);
    
    public boolean updateHeartbeat(String agentId, String status);
    
    public void saveMonitorData(String agentId, Map<String, Object> data);
    
    public List<Agent> getAllAgents();
    
    public Optional<Agent> getAgent(String agentId);
    
    public boolean updateAgent(String agentId, Map<String, String> agentInfo);
    
    public boolean deleteAgent(String agentId);
    
    public List<ProcessInfo> getProcesses(String agentId);
    
    public List<PortInfo> getPorts(String agentId);
    
    public AgentStats getAgentStats();
}
```

#### 3.3.2 BaselineService

```java
@Service
@Transactional
public class BaselineService {
    
    // 学习模式
    public BaselineConfig startQuickLearn(String agentId, String type);
    public BaselineConfig startStandardLearn(String agentId, String type);
    public BaselineConfig startCustomLearn(String agentId, String type, int days);
    
    // 创建方式
    public BaselineConfig importFromCurrent(String agentId, String type);
    public BaselineConfig copyFromAgent(String sourceAgentId, String targetAgentId, String type);
    public BaselineConfig manualCreate(String agentId, String type, List<BaselineItemDTO> items);
    
    // 查询方法
    public List<BaselineConfig> getBaselineConfigs(String agentId);
    public Optional<BaselineConfig> getBaselineConfig(String agentId, String type);
    public List<BaselineSnapshot> getSnapshots(String agentId, String type);
    public List<BaselineItem> getBaselineItems(String agentId, String type);
    
    // 对比功能
    public BaselineCompareResult compareWithBaseline(String agentId, String type);
    
    // 删除
    public void deleteBaseline(String agentId, String type);
}
```

#### 3.3.3 AlertService

```java
@Service
@Transactional
public class AlertService {
    
    // 告警操作
    public SecurityAlert createAlert(String agentId, String alertType,
        String alertLevel, String alertTitle, String alertContent);
    public List<SecurityAlert> getAllAlerts();
    public List<SecurityAlert> getAlertsByStatus(String status);
    public Optional<SecurityAlert> getAlertById(Long id);
    
    // 告警处理
    public SecurityAlert acknowledgeAlert(Long alertId, String acknowledgedBy);
    public SecurityAlert resolveAlert(Long alertId, String resolvedBy, String resolutionNote);
    public SecurityAlert ignoreAlert(Long alertId, String ignoredBy, String ignoreReason);
    
    // 统计
    public AlertStats getAlertStats();
    public long countNewAlerts();
    public long countCriticalUnresolved();
    
    // 规则管理
    public AlertRule createRule(String ruleType, String ruleName, String ruleCondition,
        String alertLevel, String actionType, boolean enabled);
    public List<AlertRule> getAllRules();
    public List<AlertRule> getEnabledRules();
    public AlertRule toggleRule(Long ruleId, boolean enabled);
    public void deleteRule(Long ruleId);
}
```

---

## 4. 前端设计

### 4.1 目录结构

```
web/src/
├── api/
│   ├── index.js              # Axios配置 + 统一导出
│   ├── agentApi.js           # Agent相关API
│   ├── baselineApi.js        # 基线管理API
│   └── alertApi.js           # 告警管理API
│
├── components/
│   └── BaselineTypePanel.vue # 基线类型面板组件
│
├── views/
│   ├── Dashboard.vue         # 仪表盘页面
│   ├── AgentList.vue         # Agent列表页面
│   ├── AgentDetail.vue       # Agent详情页面
│   ├── BaselineManager.vue   # 基线管理页面
│   └── AlertCenter.vue       # 告警中心页面
│
├── router/
│   └── index.js              # 路由配置
│
├── stores/
│   └── (Pinia stores)       # 状态管理
│
├── App.vue                   # 根组件
└── main.js                   # 应用入口
```

### 4.2 页面组件

```
views/
├── Dashboard.vue
│   ├── AgentStatsCard        # Agent统计卡片
│   ├── RecentAlerts          # 最近告警
│   └── SystemStatus          # 系统状态
│
├── AgentList.vue
│   ├── AgentTable            # Agent列表表格
│   ├── StatusTag             # 状态标签
│   └── AgentActions          # 操作按钮
│
├── AgentDetail.vue
│   ├── AgentInfoCard         # Agent信息卡片
│   ├── ProcessTable           # 进程表格
│   ├── PortTable             # 端口表格
│   ├── HostInfoPanel         # 主机信息面板
│   ├── SoftwareList           # 软件列表
│   ├── UsbDeviceList         # USB设备列表
│   └── LoginLogsTable        # 登录日志表格
│
├── BaselineManager.vue
│   ├── AgentSelect           # Agent选择器
│   └── BaselineTypePanel     # 基线类型面板
│       ├── LearnControls      # 学习控制
│       ├── SnapshotList       # 快照列表
│       └── BaselineTable      # 基线表格
│
└── AlertCenter.vue
    ├── StatsCards            # 统计卡片
    ├── AlertFilter           # 告警筛选
    ├── AlertTable            # 告警表格
    └── AlertDetailDrawer     # 告警详情抽屉
```

### 4.3 API模块设计

```javascript
// api/index.js - 统一API配置和导出
import axios from 'axios'

const API_BASE = '/api'

const api = axios.create({
  baseURL: API_BASE,
  timeout: 30000
})

// 请求拦截器
api.interceptors.request.use(config => {
  // 添加认证信息等
  return config
})

// 响应拦截器
api.interceptors.response.use(
  response => response.data,
  error => {
    // 统一错误处理
    return Promise.reject(error)
  }
)

export const agentApi = {
  getAllAgents: () => api.get('/agents'),
  getAgent: (id) => api.get(`/agents/${id}`),
  // ... 其他方法
}

export { baselineApi, alertApi }
export default api
```

---

## 5. 数据库设计

### 5.1 ER图

```
┌─────────────────┐       ┌─────────────────┐
│     agents      │       │   processes     │
├─────────────────┤       ├─────────────────┤
│ id (PK)         │◄──────│ agent_id (FK)   │
│ name            │       │ id (PK)         │
│ platform        │       │ pid             │
│ hostname        │       │ name            │
│ ip_address      │       │ cpu_percent     │
│ status          │       │ memory_percent  │
│ created_at      │       │ status          │
│ updated_at      │       │ collected_at    │
└─────────────────┘       └─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│     ports       │       │   host_info     │
├─────────────────┤       ├─────────────────┤
│ agent_id (FK)   │       │ agent_id (FK)   │
│ id (PK)         │       │ id (PK)         │
│ port            │       │ cpu_brand       │
│ protocol        │       │ cpu_cores       │
│ status          │       │ memory_total    │
│ process_name    │       │ os_name         │
│ collected_at    │       │ collected_at    │
└─────────────────┘       └─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│ baseline_config │       │baseline_snapshot │
├─────────────────┤       ├─────────────────┤
│ id (PK)         │◄──────│ config_id (FK)   │
│ agent_id        │       │ id (PK)         │
│ baseline_type   │       │ agent_id        │
│ status          │       │ baseline_type   │
│ learning_mode   │       │ snapshot_hash   │
│ learning_days   │       │ item_count      │
│ learn_start     │       │ valid_from      │
│ learn_end      │       └────────┬────────┘
└─────────────────┘                │
                                 │ 1:N
                                 ▼
                        ┌─────────────────┐
                        │  baseline_item  │
                        ├─────────────────┤
                        │ snapshot_id(FK) │
                        │ id (PK)         │
                        │ item_key        │
                        │ item_value      │
                        │ item_type       │
                        │ item_hash       │
                        └─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│ security_alert  │       │   alert_rule    │
├─────────────────┤       ├─────────────────┤
│ id (PK)         │       │ id (PK)        │
│ agent_id        │       │ rule_name      │
│ alert_type      │       │ rule_type      │
│ alert_level     │       │ rule_condition  │
│ alert_title     │       │ alert_level    │
│ alert_content   │       │ enabled        │
│ alert_status    │       │ created_at    │
│ created_at      │       └─────────────────┘
└─────────────────┘
```

### 5.2 核心表结构

详见《数据库设计文档》

---

## 6. API设计

### 6.1 API列表

详见《数据库设计文档》中的API端点说明

### 6.2 统一响应格式

```json
{
  "success": true,
  "message": "操作成功",
  "data": {
    // 业务数据
  }
}
```

### 6.3 错误响应

```json
{
  "success": false,
  "message": "错误描述",
  "error": "详细错误信息"
}
```

---

## 7. 安全设计

### 7.1 认证机制

- Agent注册时分配唯一ID
- 所有API请求携带Agent ID
- 生产环境建议添加Token认证

### 7.2 数据校验

```java
@RestController
public class AgentController {
    
    @PostMapping("/register")
    public ResponseEntity<?> register(
        @Valid @RequestBody AgentRegistrationDTO agentInfo,
        BindingResult result
    ) {
        if (result.hasErrors()) {
            return ResponseEntity.badRequest()
                .body(result.getAllErrors());
        }
        // 处理注册
    }
}
```

### 7.3 审计日志

```java
@RestController
public class AgentController {
    
    private static final Logger logger = 
        LoggerFactory.getLogger(AgentController.class);
    
    @DeleteMapping("/{agentId}")
    public ResponseEntity<?> deleteAgent(@PathVariable String agentId) {
        logger.info("删除Agent: {}", agentId);
        // 删除逻辑
    }
}
```

---

## 8. 部署架构

### 8.1 单机部署

```
┌────────────────────────────────────────────────────────────┐
│                      部署服务器                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   MySQL    │  │  Backend   │  │    Web     │         │
│  │   :3306    │  │   :8080    │  │   :3000    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                         │                                  │
│                         ▼                                  │
│              ┌─────────────────────────┐                    │
│              │     Nginx (可选)       │                    │
│              │  80 -> 3000, 8080     │                    │
│              └─────────────────────────┘                    │
└────────────────────────────────────────────────────────────┘
```

### 8.2 Docker Compose部署

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: terminal_monitor

  backend:
    build: ./backend
    ports:
      - "8080:8080"
    depends_on:
      mysql:
        condition: service_healthy

  web:
    build: ./web
    ports:
      - "3000:80"
    depends_on:
      - backend
```

### 8.3 分布式部署

```
┌─────────────────────────────────────────────────────────────┐
│                       负载均衡层                            │
│                  Nginx / HAProxy                            │
│                   :80 -> backend-1, backend-2                │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│      Backend-1          │     │      Backend-2          │
│     SpringBoot         │     │     SpringBoot          │
│       :8080            │     │       :8080             │
└─────────────────────────┘     └─────────────────────────┘
              │                               │
              └───────────────┬───────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│       MySQL主库         │     │      MySQL从库         │
│      (读写)            │     │      (只读)            │
└─────────────────────────┘     └─────────────────────────┘
```

---

## 9. 扩展性设计

### 9.1 新增基线类型

1. 在枚举类中添加新类型
2. 创建对应的Repository
3. 实现数据采集逻辑
4. 添加检测规则

### 9.2 新增告警级别

1. 修改SecurityAlert实体
2. 修改前端组件
3. 更新验证规则

### 9.3 集成外部系统

- 邮件通知：扩展AlertService
- 短信通知：扩展AlertService
- SIEM集成：添加导出接口

---

## 10. 性能优化

### 10.1 数据库优化

- 常用查询字段建立索引
- 分页查询限制单页数量
- 定期清理历史数据

### 10.2 缓存策略

- 启用Spring Cache
- 基线配置缓存
- 告警统计缓存

### 10.3 异步处理

- 告警生成异步处理
- 大量数据导入异步处理
- 邮件/短信通知异步发送
