# 终端安全监控系统 - 完整数据库设计文档

## 版本信息

| 项目 | 内容 |
|------|------|
| 版本号 | v1.0.0 |
| 文档版本 | 3.0 |
| 创建日期 | 2026-02-11 |
| 数据库 | MySQL 8.0+ |
| 状态 | 正式发布 |

---

## 目录

1. [数据库概述](#1-数据库概述)
2. [核心表结构](#2-核心表结构)
3. [监控数据表](#3-监控数据表)
4. [基线管理表](#4-基线管理表)
5. [告警管理表](#5-告警管理表)
6. [索引设计](#6-索引设计)
7. [SQL示例](#7-sql示例)
8. [数据维护](#8-数据维护)

---

## 1. 数据库概述

### 1.1 数据库信息

| 项目 | 内容 |
|------|------|
| 数据库名 | terminal_monitor |
| 字符集 | utf8mb4 |
| 排序规则 | utf8mb4_unicode_ci |
| 存储引擎 | InnoDB |

### 1.2 数据库ER图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           核心实体关系图                                      │
└─────────────────────────────────────────────────────────────────────────────┘

agents (Agent信息表)
     │
     ├── 1:N ─── processes (进程信息表)
     │           │
     │           └── pid, name, cpu_percent, memory_percent, status
     │
     ├── 1:N ─── ports (端口信息表)
     │           │
     │           └── port, protocol, status, process_name
     │
     ├── 1:N ─── host_info (主机信息表)
     │           │
     │           └── cpu_brand, memory_total, os_name, storage_devices
     │
     ├── 1:N ─── usb_devices (USB设备表)
     │           │
     │           └── device_name, vendor_id, product_id, serial_number
     │
     ├── 1:N ─── login_logs (登录日志表)
     │           │
     │           └── username, login_type, login_time, login_ip
     │
     ├── 1:N ─── installed_software (已安装软件表)
     │           │
     │           └── name, version, publisher, install_date
     │
     ├── 1:N ─── baseline_config (基线配置表)
     │           │
     │           └── 1:N ─── baseline_snapshot (基线快照表)
     │                            │
     │                            └── 1:N ─── baseline_item (基线项目表)
     │                                        │
     │                                        └── item_key, item_value
     │
     └── 1:N ─── security_alert (安全告警表)
                 │
                 └── alert_type, alert_level, alert_status, created_at

alert_rule (告警规则表)
    │
    └── rule_type, rule_condition, alert_level, enabled
```

### 1.3 表清单

| 序号 | 表名 | 中文名 | 说明 |
|------|------|--------|------|
| 1 | agents | Agent信息表 | 存储Agent基本信息 |
| 2 | processes | 进程信息表 | 存储采集的进程数据 |
| 3 | ports | 端口信息表 | 存储采集的端口数据 |
| 4 | host_info | 主机信息表 | 存储采集的主机信息 |
| 5 | usb_devices | USB设备表 | 存储USB设备信息 |
| 6 | login_logs | 登录日志表 | 存储登录日志 |
| 7 | installed_software | 已安装软件表 | 存储已安装软件信息 |
| 8 | baseline_config | 基线配置表 | 存储基线配置 |
| 9 | baseline_snapshot | 基线快照表 | 存储基线快照 |
| 10 | baseline_item | 基线项目表 | 存储基线项目详情 |
| 11 | security_alert | 安全告警表 | 存储告警信息 |
| 12 | alert_rule | 告警规则表 | 存储告警规则 |

---

## 2. 核心表结构

### 2.1 agents表 - Agent信息表

#### 2.1.1 表结构

```sql
CREATE TABLE agents (
    id VARCHAR(36) PRIMARY KEY COMMENT 'Agent唯一标识(UUID)',
    name VARCHAR(100) NOT NULL COMMENT 'Agent名称',
    platform VARCHAR(100) COMMENT '平台信息',
    hostname VARCHAR(100) COMMENT '主机名',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    status VARCHAR(20) DEFAULT 'offline' COMMENT '在线状态: online/offline',
    version VARCHAR(20) COMMENT 'Agent版本',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    last_heartbeat DATETIME COMMENT '最后心跳时间',
    UNIQUE INDEX uk_name (name),
    INDEX idx_status (status),
    INDEX idx_hostname (hostname)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Agent信息表';
```

#### 2.1.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | VARCHAR(36) | 是 | - | 主键，UUID格式 |
| name | VARCHAR(100) | 是 | - | Agent名称，唯一 |
| platform | VARCHAR(100) | 否 | - | 操作系统平台 |
| hostname | VARCHAR(100) | 否 | - | 主机名 |
| ip_address | VARCHAR(50) | 否 | - | IP地址 |
| status | VARCHAR(20) | 否 | offline | 在线状态 |
| version | VARCHAR(20) | 否 | - | Agent版本号 |
| created_at | DATETIME | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | 否 | CURRENT_TIMESTAMP | 更新时间 |
| last_heartbeat | DATETIME | 否 | - | 最后心跳时间 |

#### 2.1.3 枚举值

| 字段 | 可选值 |
|------|--------|
| status | online, offline, maintenance |

---

## 3. 监控数据表

### 3.1 processes表 - 进程信息表

#### 3.1.1 表结构

```sql
CREATE TABLE processes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    pid INT NOT NULL COMMENT '进程ID',
    name VARCHAR(255) COMMENT '进程名称',
    cpu_percent DECIMAL(5,2) COMMENT 'CPU占用率',
    memory_percent DECIMAL(5,2) COMMENT '内存占用率',
    status VARCHAR(20) COMMENT '进程状态',
    create_time VARCHAR(50) COMMENT '进程创建时间',
    username VARCHAR(100) COMMENT '进程用户名',
    collected_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '采集时间',
    INDEX idx_agent_collected (agent_id, collected_at),
    INDEX idx_agent_pid (agent_id, pid),
    INDEX idx_name (name),
    CONSTRAINT fk_process_agent FOREIGN KEY (agent_id)
        REFERENCES agents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='进程信息表';
```

### 3.2 ports表 - 端口信息表

#### 3.2.1 表结构

```sql
CREATE TABLE ports (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    port INT NOT NULL COMMENT '端口号',
    protocol VARCHAR(10) DEFAULT 'TCP' COMMENT '协议',
    status VARCHAR(20) COMMENT '端口状态',
    pid INT COMMENT '进程ID',
    process_name VARCHAR(255) COMMENT '进程名称',
    collected_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '采集时间',
    INDEX idx_agent_port (agent_id, port),
    INDEX idx_agent_collected (agent_id, collected_at),
    CONSTRAINT fk_port_agent FOREIGN KEY (agent_id)
        REFERENCES agents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='端口信息表';
```

### 3.3 host_info表 - 主机信息表

#### 3.3.1 表结构

```sql
CREATE TABLE host_info (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    cpu_brand VARCHAR(200) COMMENT 'CPU品牌',
    cpu_arch VARCHAR(50) COMMENT 'CPU架构',
    cpu_cores INT COMMENT 'CPU核心数',
    cpu_threads INT COMMENT 'CPU线程数',
    cpu_frequency DECIMAL(10,2) COMMENT 'CPU频率(GHz)',
    memory_total BIGINT COMMENT '内存总量(字节)',
    memory_available BIGINT COMMENT '可用内存(字节)',
    memory_percent DECIMAL(5,2) COMMENT '内存使用率',
    memory_human VARCHAR(50) COMMENT '内存总量(人类可读)',
    storage_devices JSON COMMENT '存储设备列表(JSON)',
    storage_total BIGINT COMMENT '存储总量(字节)',
    motherboard_model VARCHAR(200) COMMENT '主板型号',
    motherboard_serial VARCHAR(100) COMMENT '主板序列号',
    bios_version VARCHAR(100) COMMENT 'BIOS版本',
    os_name VARCHAR(200) COMMENT '操作系统名称',
    os_version VARCHAR(100) COMMENT '操作系统版本',
    os_arch VARCHAR(50) COMMENT '系统架构',
    kernel_version VARCHAR(100) COMMENT '内核版本',
    mac_addresses JSON COMMENT 'MAC地址列表(JSON)',
    ip_addresses JSON COMMENT 'IP地址列表(JSON)',
    collected_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '采集时间',
    INDEX idx_agent_collected (agent_id, collected_at),
    CONSTRAINT fk_host_agent FOREIGN KEY (agent_id)
        REFERENCES agents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='主机信息表';
```

### 3.4 usb_devices表 - USB设备表

#### 3.4.1 表结构

```sql
CREATE TABLE usb_devices (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    device_name VARCHAR(300) COMMENT '设备名称',
    device_type VARCHAR(50) COMMENT '设备类型',
    vendor_id VARCHAR(20) COMMENT '厂商ID',
    product_id VARCHAR(20) COMMENT '产品ID',
    serial_number VARCHAR(100) COMMENT '序列号',
    manufacturer VARCHAR(200) COMMENT '制造商',
    plugged_time DATETIME COMMENT '接入时间',
    collected_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '采集时间',
    INDEX idx_agent_collected (agent_id, collected_at),
    INDEX idx_serial (serial_number),
    CONSTRAINT fk_usb_agent FOREIGN KEY (agent_id)
        REFERENCES agents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='USB设备表';
```

### 3.5 login_logs表 - 登录日志表

#### 3.5.1 表结构

```sql
CREATE TABLE login_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    username VARCHAR(100) COMMENT '用户名',
    login_type VARCHAR(50) COMMENT '登录类型',
    login_time DATETIME COMMENT '登录时间',
    logout_time DATETIME COMMENT '登出时间',
    login_ip VARCHAR(50) COMMENT '登录IP',
    login_status VARCHAR(20) COMMENT '登录状态',
    session_id VARCHAR(100) COMMENT '会话ID',
    source VARCHAR(100) COMMENT '日志来源',
    collected_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '采集时间',
    INDEX idx_agent_time (agent_id, login_time),
    INDEX idx_username (username),
    INDEX idx_ip (login_ip),
    CONSTRAINT fk_login_agent FOREIGN KEY (agent_id)
        REFERENCES agents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='登录日志表';
```

### 3.6 installed_software表 - 已安装软件表

#### 3.6.1 表结构

```sql
CREATE TABLE installed_software (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    name VARCHAR(300) COMMENT '软件名称',
    version VARCHAR(100) COMMENT '版本号',
    publisher VARCHAR(200) COMMENT '发行商',
    install_date VARCHAR(50) COMMENT '安装日期',
    install_location VARCHAR(500) COMMENT '安装路径',
    collected_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '采集时间',
    INDEX idx_agent_collected (agent_id, collected_at),
    INDEX idx_name (name),
    CONSTRAINT fk_software_agent FOREIGN KEY (agent_id)
        REFERENCES agents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='已安装软件表';
```

---

## 4. 基线管理表

### 4.1 baseline_config表 - 基线配置表

#### 4.1.1 表结构

```sql
CREATE TABLE baseline_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    baseline_type VARCHAR(20) NOT NULL COMMENT '基线类型',
    status VARCHAR(20) DEFAULT 'LEARNING' COMMENT '状态',
    learning_mode VARCHAR(20) COMMENT '学习模式',
    learning_days INT COMMENT '学习天数',
    learn_start DATETIME COMMENT '学习开始时间',
    learn_end DATETIME COMMENT '学习结束时间',
    created_type VARCHAR(20) COMMENT '创建类型',
    source_agent_id VARCHAR(36) COMMENT '源Agent ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_agent_type (agent_id, baseline_type),
    INDEX idx_agent_id (agent_id),
    INDEX idx_status (status),
    CONSTRAINT fk_config_agent FOREIGN KEY (agent_id)
        REFERENCES agents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='基线配置表';
```

#### 4.1.2 枚举值

| 字段 | 可选值 |
|------|--------|
| baseline_type | PROCESS, PORT, USB, LOGIN, SOFTWARE |
| status | LEARNING, ACTIVE |
| learning_mode | QUICK, STANDARD, CUSTOM, MANUAL |
| created_type | LEARNING, IMPORT, COPY, MANUAL |

### 4.2 baseline_snapshot表 - 基线快照表

#### 4.2.1 表结构

```sql
CREATE TABLE baseline_snapshot (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    baseline_type VARCHAR(20) NOT NULL COMMENT '基线类型',
    config_id BIGINT COMMENT '配置ID',
    snapshot_hash VARCHAR(64) COMMENT '快照哈希值(SHA-256)',
    item_count INT DEFAULT 0 COMMENT '项目数量',
    valid_from DATETIME COMMENT '生效时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_agent_type (agent_id, baseline_type),
    INDEX idx_created_at (created_at),
    CONSTRAINT fk_snapshot_config FOREIGN KEY (config_id)
        REFERENCES baseline_config(id) ON DELETE SET NULL,
    CONSTRAINT fk_snapshot_agent FOREIGN KEY (agent_id)
        REFERENCES agents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='基线快照表';
```

### 4.3 baseline_item表 - 基线项目表

#### 4.3.1 表结构

```sql
CREATE TABLE baseline_item (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    snapshot_id BIGINT NOT NULL COMMENT '快照ID',
    item_key VARCHAR(255) NOT NULL COMMENT '项目键',
    item_value TEXT COMMENT '项目值',
    item_type VARCHAR(50) COMMENT '项目类型',
    item_hash VARCHAR(64) COMMENT '项目哈希值(SHA-256)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_snapshot (snapshot_id),
    INDEX idx_item_key (item_key(100)),
    CONSTRAINT fk_item_snapshot FOREIGN KEY (snapshot_id)
        REFERENCES baseline_snapshot(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='基线项目表';
```

---

## 5. 告警管理表

### 5.1 security_alert表 - 安全告警表

#### 5.1.1 表结构

```sql
CREATE TABLE security_alert (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    alert_type VARCHAR(50) NOT NULL COMMENT '告警类型',
    alert_level VARCHAR(20) NOT NULL COMMENT '告警级别',
    alert_title VARCHAR(200) NOT NULL COMMENT '告警标题',
    alert_content TEXT COMMENT '告警内容',
    anomaly_type VARCHAR(50) COMMENT '异常类型',
    baseline_item JSON COMMENT '基线项目数据',
    current_item JSON COMMENT '当前项目数据',
    alert_status VARCHAR(20) DEFAULT 'NEW' COMMENT '告警状态',
    acknowledged_by VARCHAR(100) COMMENT '确认人',
    acknowledged_at DATETIME COMMENT '确认时间',
    resolved_by VARCHAR(100) COMMENT '解决人',
    resolved_at DATETIME COMMENT '解决时间',
    resolution_note TEXT COMMENT '解决备注',
    ignored_by VARCHAR(100) COMMENT '忽略人',
    ignored_at DATETIME COMMENT '忽略时间',
    ignore_reason TEXT COMMENT '忽略原因',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_agent_status (agent_id, alert_status),
    INDEX idx_alert_level (alert_level),
    INDEX idx_created_at (created_at),
    INDEX idx_status (alert_status),
    CONSTRAINT fk_alert_agent FOREIGN KEY (agent_id)
        REFERENCES agents(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='安全告警表';
```

#### 5.1.2 枚举值

| 字段 | 可选值 |
|------|--------|
| alert_type | PROCESS, PORT, USB, LOGIN, SOFTWARE, SYSTEM |
| alert_level | CRITICAL, HIGH, MEDIUM, LOW |
| anomaly_type | NEW, MISSING, MODIFIED |
| alert_status | NEW, ACKNOWLEDGED, RESOLVED, IGNORED |

### 5.2 alert_rule表 - 告警规则表

#### 5.2.1 表结构

```sql
CREATE TABLE alert_rule (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL COMMENT '规则名称',
    rule_type VARCHAR(50) NOT NULL COMMENT '规则类型',
    rule_condition VARCHAR(500) NOT NULL COMMENT '规则条件',
    action_type VARCHAR(50) DEFAULT 'ALERT' COMMENT '动作类型',
    alert_level VARCHAR(20) DEFAULT 'MEDIUM' COMMENT '告警级别',
    enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    description TEXT COMMENT '规则描述',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_rule_name (rule_name),
    INDEX idx_rule_type (rule_type),
    INDEX idx_enabled (enabled)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警规则表';
```

#### 5.2.2 枚举值

| 字段 | 可选值 |
|------|--------|
| rule_type | PROCESS, PORT, USB, LOGIN, SOFTWARE, SYSTEM |
| action_type | ALERT, BLOCK, NOTIFY |
| alert_level | CRITICAL, HIGH, MEDIUM, LOW |

---

## 6. 索引设计

### 6.1 索引清单

| 表名 | 索引类型 | 索引字段 | 说明 |
|------|----------|----------|------|
| agents | UNIQUE | name | Agent名称唯一约束 |
| agents | INDEX | status | 状态快速筛选 |
| agents | INDEX | hostname | 主机名搜索 |
| processes | INDEX | agent_id, collected_at | 按时间查询进程 |
| processes | INDEX | agent_id, pid | 按进程ID查询 |
| processes | INDEX | name | 进程名搜索 |
| ports | INDEX | agent_id, port | 按端口查询 |
| ports | INDEX | agent_id, collected_at | 按时间查询端口 |
| host_info | INDEX | agent_id, collected_at | 按时间查询主机信息 |
| usb_devices | INDEX | agent_id, collected_at | 按时间查询USB设备 |
| usb_devices | INDEX | serial_number | 序列号搜索 |
| login_logs | INDEX | agent_id, login_time | 按时间查询登录日志 |
| login_logs | INDEX | username | 用户名搜索 |
| login_logs | INDEX | login_ip | IP搜索 |
| installed_software | INDEX | agent_id, collected_at | 按时间查询软件 |
| installed_software | INDEX | name | 软件名搜索 |
| baseline_config | UNIQUE | agent_id, baseline_type | 配置唯一约束 |
| baseline_config | INDEX | agent_id | Agent筛选 |
| baseline_config | INDEX | status | 状态筛选 |
| baseline_snapshot | INDEX | agent_id, baseline_type | 按类型查询快照 |
| baseline_snapshot | INDEX | created_at | 创建时间排序 |
| baseline_item | INDEX | snapshot_id | 快照关联 |
| baseline_item | INDEX | item_key | 项目键搜索 |
| security_alert | INDEX | agent_id, alert_status | 按状态查询告警 |
| security_alert | INDEX | alert_level | 级别筛选 |
| security_alert | INDEX | created_at | 时间排序 |
| security_alert | INDEX | alert_status | 状态筛选 |
| alert_rule | UNIQUE | rule_name | 规则名称唯一 |
| alert_rule | INDEX | rule_type | 类型筛选 |
| alert_rule | INDEX | enabled | 启用状态 |

### 6.2 复合索引说明

```sql
-- 按Agent和时间查询进程
INDEX idx_agent_collected (agent_id, collected_at)

-- 按Agent和类型查询基线
INDEX idx_agent_type (agent_id, baseline_type)

-- 按Agent和状态查询告警
INDEX idx_agent_status (agent_id, alert_status)
```

---

## 7. SQL示例

### 7.1 Agent相关查询

```sql
-- 查询所有在线Agent
SELECT * FROM agents WHERE status = 'online';

-- 查询Agent最新进程数据
SELECT * FROM processes 
WHERE agent_id = 'xxx' 
ORDER BY collected_at DESC 
LIMIT 100;

-- 查询Agent端口信息
SELECT * FROM ports 
WHERE agent_id = 'xxx' 
  AND status = 'LISTEN'
ORDER BY port;
```

### 7.2 基线相关查询

```sql
-- 查询Agent的活跃基线配置
SELECT * FROM baseline_config
WHERE agent_id = 'xxx'
  AND status = 'ACTIVE';

-- 查询基线快照列表
SELECT * FROM baseline_snapshot
WHERE agent_id = 'xxx'
  AND baseline_type = 'PROCESS'
ORDER BY created_at DESC
LIMIT 10;

-- 查询基线对比-新增进程（在当前但不在基线中）
SELECT p.* 
FROM processes p
LEFT JOIN baseline_snapshot s ON s.agent_id = p.agent_id
LEFT JOIN baseline_item i ON i.snapshot_id = s.id
WHERE s.agent_id = 'xxx'
  AND s.baseline_type = 'PROCESS'
  AND i.id IS NULL;
```

### 7.3 告警相关查询

```sql
-- 查询待处理告警
SELECT * FROM security_alert
WHERE alert_status = 'NEW'
ORDER BY 
  CASE alert_level 
    WHEN 'CRITICAL' THEN 1 
    WHEN 'HIGH' THEN 2 
    WHEN 'MEDIUM' THEN 3 
    WHEN 'LOW' THEN 4 
  END,
  created_at DESC;

-- 查询严重未解决告警
SELECT * FROM security_alert
WHERE alert_level = 'CRITICAL'
  AND alert_status != 'RESOLVED'
ORDER BY created_at DESC;

-- 告警统计
SELECT 
  alert_status,
  COUNT(*) as count
FROM security_alert
GROUP BY alert_status;
```

### 7.4 数据统计查询

```sql
-- Agent统计
SELECT 
  status,
  COUNT(*) as count
FROM agents
GROUP BY status;

-- 按Agent统计进程数
SELECT 
  agent_id,
  COUNT(*) as process_count
FROM processes
WHERE collected_at > DATE_SUB(NOW(), INTERVAL 24 HOUR)
GROUP BY agent_id;
```

---

## 8. 数据维护

### 8.1 数据保留策略

| 数据类型 | 保留期限 | 说明 |
|----------|----------|------|
| 告警数据 | 90天 | 可配置 |
| 进程快照 | 30天 | 保留最近30天 |
| 端口快照 | 30天 | 保留最近30天 |
| 主机信息 | 90天 | 最新记录长期保留 |
| 登录日志 | 90天 | 可配置 |
| 基线快照 | 永久 | 保留历史版本 |

### 8.2 数据清理SQL

```sql
-- 清理30天前的进程数据
DELETE FROM processes 
WHERE collected_at < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- 清理90天前的告警数据
DELETE FROM security_alert 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY)
  AND alert_status IN ('RESOLVED', 'IGNORED');

-- 清理90天前的登录日志
DELETE FROM login_logs 
WHERE login_time < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- 保留每个Agent最近5个基线快照
DELETE FROM baseline_item
WHERE snapshot_id IN (
    SELECT id FROM (
        SELECT id FROM baseline_snapshot
        WHERE agent_id = 'xxx'
          AND baseline_type = 'PROCESS'
        ORDER BY created_at DESC
        LIMIT 5 OFFSET 5
    ) old_snapshots
);

DELETE FROM baseline_snapshot
WHERE agent_id = 'xxx'
  AND baseline_type = 'PROCESS'
  AND id NOT IN (
      SELECT id FROM (
          SELECT id FROM baseline_snapshot
          WHERE agent_id = 'xxx'
            AND baseline_type = 'PROCESS'
          ORDER BY created_at DESC
          LIMIT 5
      ) recent
  );
```

### 8.3 备份策略

```bash
# 每日全量备份
mysqldump -u root -p terminal_monitor > backup_$(date +%Y%m%d).sql

# 增量备份（需要开启binlog）
mysqlbinlog --start-datetime='2026-02-11 00:00:00' mysql-bin.000001 > incremental_backup.sql

# 恢复
mysql -u root -p terminal_monitor < backup_20260211.sql
```

### 8.4 分区策略示例

```sql
-- 按时间分区告警表
ALTER TABLE security_alert
PARTITION BY RANGE (TO_DAYS(created_at)) (
    PARTITION p_2026_01 VALUES LESS THAN (TO_DAYS('2026-02-01')),
    PARTITION p_2026_02 VALUES LESS THAN (TO_DAYS('2026-03-01')),
    PARTITION p_2026_03 VALUES LESS THAN (TO_DAYS('2026-04-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

## 9. 数据库优化建议

### 9.1 查询优化

- 避免SELECT *，只查询必要字段
- 使用分页查询限制结果集
- 合理使用复合索引
- 定期执行ANALYZE TABLE更新统计信息

### 9.2 性能监控

```sql
-- 查看慢查询日志
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- 查看当前连接数
SHOW STATUS LIKE 'Threads_connected';

-- 查看缓存命中率
SHOW STATUS LIKE 'Qcache%';
```

### 9.3 硬件配置建议

| 配置项 | 最低配置 | 推荐配置 |
|--------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 磁盘 | 100GB SSD | 500GB SSD+ |
| 并发连接 | 100 | 500+ |
