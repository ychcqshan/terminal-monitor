# 终端安全监控系统 - 部署与运行文档

## 版本信息

| 项目 | 内容 |
|------|------|
| 版本号 | v1.0.0 |
| 文档版本 | 2.0 |
| 创建日期 | 2026-02-11 |
| 状态 | 正式发布 |

---

## 目录

1. [环境要求](#1-环境要求)
2. [快速部署(Docker)](#2-快速部署docker)
3. [本地开发部署](#3-本地开发部署)
4. [Agent部署](#4-agent部署)
5. [配置说明](#5-配置说明)
6. [验证部署](#6-验证部署)
7. [常见问题](#7-常见问题)
8. [运维管理](#8-运维管理)

---

## 1. 环境要求

### 1.1 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 磁盘 | 50GB | 200GB+ SSD |
| 网络 | 10Mbps | 100Mbps |

### 1.2 软件要求

#### 1.2.1 Docker部署

| 软件 | 版本要求 |
|------|----------|
| Docker | 20.10+ |
| Docker Compose | 2.0+ |

#### 1.2.2 本地开发

| 软件 | 版本要求 | 用途 |
|------|----------|------|
| Java | 17+ | 后端运行 |
| Maven | 3.8+ | 后端构建 |
| Node.js | 18+ | 前端构建 |
| npm | 9+ | 前端依赖管理 |
| MySQL | 8.0+ | 数据库 |
| Python | 3.8+ | Agent运行 |

### 1.3 支持的操作系统

| 系统 | 版本 | Agent支持 | 后端支持 | 前端支持 |
|------|------|-----------|----------|----------|
| Ubuntu | 18.04+ | ✅ | ✅ | ✅ |
| CentOS | 7+ | ✅ | ✅ | ✅ |
| Debian | 10+ | ✅ | ✅ | ✅ |
| Windows | 10+ | ✅ | ✅ | ✅ |
| macOS | 10.15+ | ✅ | ✅ | ✅ |

---

## 2. 快速部署(Docker)

### 2.1 前置条件

```bash
# 1. 安装Docker
# Ubuntu:
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# Windows/macOS:
# 下载Docker Desktop安装

# 2. 验证安装
docker --version
docker-compose --version
```

### 2.2 部署步骤

```bash
# 1. 克隆项目
git clone <repository-url>
cd terminal-monitor

# 2. 启动所有服务
docker-compose up -d

# 3. 查看服务状态
docker-compose ps

# 4. 查看日志
docker-compose logs -f
```

### 2.3 服务访问

| 服务 | 地址 | 说明 |
|------|------|------|
| Web界面 | http://localhost:3000 | 前端Web界面 |
| 后端API | http://localhost:8080/api | REST API |
| MySQL | localhost:3306 | 数据库( root/password) |

### 2.4 Docker Compose配置

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: terminal-monitor-mysql
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: terminal_monitor
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - monitor-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: terminal-monitor-backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/terminal_monitor?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: password
    ports:
      - "8080:8080"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - monitor-network
    restart: unless-stopped

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: terminal-monitor-web
    ports:
      - "3000:80
    depends_on:
      - backend
    networks:
      - monitor-network
    restart: unless-stopped

networks:
  monitor-network:
    driver: bridge

volumes:
  mysql_data:
```

### 2.5 停止服务

```bash
# 停止服务（保留数据）
docker-compose down

# 停止并删除数据卷
docker-compose down -v
```

---

## 3. 本地开发部署

### 3.1 数据库部署

```bash
# 方式1: Docker运行MySQL
docker run -d \
  --name terminal-monitor-mysql \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=password \
  -e MYSQL_DATABASE=terminal_monitor \
  mysql:8.0

# 方式2: 本地安装MySQL
# 下载地址: https://dev.mysql.com/downloads/mysql/8.0.html
# 安装后创建数据库:
CREATE DATABASE terminal_monitor CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 3.2 后端部署

```bash
# 1. 进入后端目录
cd backend

# 2. 构建项目
./mvnw clean package -DskipTests

# 3. 运行后端
java -jar target/terminal-monitor-backend-1.0.0.jar

# 或者使用Spring Boot运行
./mvnw spring-boot:run
```

### 3.3 前端部署

```bash
# 1. 进入前端目录
cd web

# 2. 安装依赖
npm install

# 3. 开发模式运行
npm run dev

# 4. 生产构建
npm run build
```

### 3.4 代理配置

如果前后端分开部署，需要配置Nginx代理：

```nginx
server {
    listen 80;
    server_name localhost;

    # 前端静态文件
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## 4. Agent部署

### 4.1 Windows部署

#### 4.1.1 方式1: 直接运行

```bash
# 1. 安装Python依赖
pip install -r requirements.txt

# 2. 编辑配置文件
# 修改 config.json 中的 server_url

# 3. 运行Agent
python main.py --server-url http://your-server:8080
```

#### 4.1.2 方式2: Windows服务(可选)

```powershell
# 使用NSSM将Agent安装为Windows服务
# 下载地址: https://nssm.cc/

nssm install TerminalMonitorAgent "C:\Python39\python.exe" "C:\agent\main.py"
nssm set TerminalMonitorAgent AppParameters "--server-url http://your-server:8080"
nssm set TerminalMonitorAgent AppDirectory "C:\agent"
nssm set TerminalMonitorAgent DisplayName "Terminal Monitor Agent"
nssm set TerminalMonitorAgent Description "终端安全监控Agent"
nssm set TerminalMonitorAgent Start SERVICE_AUTO_START

# 启动服务
nssm start TerminalMonitorAgent
```

### 4.2 Linux部署

#### 4.2.1 方式1: 直接运行

```bash
# 1. 安装依赖
pip3 install -r requirements.txt

# 2. 编辑配置文件
vim config.json

# 3. 运行Agent
python3 main.py --server-url http://your-server:8080
```

#### 4.2.2 方式2: Systemd服务

```bash
# 1. 创建服务文件
sudo tee /etc/systemd/system/terminal-monitor-agent.service <<EOF
[Unit]
Description=Terminal Monitor Agent
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/terminal-monitor-agent
ExecStart=/usr/bin/python3 /opt/terminal-monitor-agent/main.py --server-url http://your-server:8080
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 2. 部署Agent
sudo mkdir -p /opt/terminal-monitor-agent
sudo cp -r . /opt/terminal-monitor-agent/

# 3. 启动服务
sudo systemctl daemon-reload
sudo systemctl enable terminal-monitor-agent
sudo systemctl start terminal-monitor-agent

# 4. 查看状态
sudo systemctl status terminal-monitor-agent
```

### 4.3 Docker运行Agent

```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["python", "main.py", "--server-url", "http://your-server:8080"]
```

```bash
docker run -d \
  --name terminal-monitor-agent \
  --restart=always \
  -v /proc:/host/proc:ro \
  terminal-monitor-agent:latest
```

### 4.4 Agent配置

```json
// config.json
{
  "server_url": "http://localhost:8080",
  "agent_id": null,
  "agent_name": null,
  "collect_interval": 60,
  "heartbeat_interval": 30,
  "retry_times": 3,
  "retry_interval": 5,
  "db_path": "./data/agent.db",
  "log_level": "INFO"
}
```

### 4.5 环境变量配置

```bash
# Linux/macOS
export SERVER_URL="http://your-server:8080"
export AGENT_NAME="my-agent"
export COLLECT_INTERVAL=60

# Windows
set SERVER_URL=http://your-server:8080
set AGENT_NAME=my-agent
```

---

## 5. 配置说明

### 5.1 后端配置

#### 5.1.1 application.yml

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/terminal_monitor?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        format_sql: true

app:
  host: 0.0.0.0
  port: 8080

logging:
  level:
    com.monitor: DEBUG
    org.springframework.web: DEBUG
```

#### 5.1.2 配置项说明

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| server.port | 服务端口 | 8080 |
| spring.datasource.url | 数据库连接URL | - |
| spring.datasource.username | 数据库用户名 | - |
| spring.datasource.password | 数据库密码 | - |
| spring.jpa.hibernate.ddl-auto | 表结构自动更新 | update |
| app.host | 监听地址 | 0.0.0.0 |

### 5.2 前端配置

#### 5.2.1 Vite配置

```javascript
// vite.config.js
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true
      }
    }
  }
})
```

### 5.3 Nginx配置(生产)

```nginx
server {
    listen 80;
    server_name monitor.example.com;

    # Gzip压缩
    gzip on;
    gzip_types text/plain application/json application/javascript text/css;

    # 前端静态文件
    location / {
        root /var/www/terminal-monitor-web;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端API
    location /api {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket (可选)
    location /ws {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 健康检查
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
```

---

## 6. 验证部署

### 6.1 验证后端服务

```bash
# 健康检查
curl http://localhost:8080/api/health

# 预期响应:
# {"status":"UP"}

# 获取Agent列表
curl http://localhost:8080/api/agents

# 预期响应:
# []
```

### 6.2 验证Web服务

```bash
# 访问Web界面
# 浏览器打开: http://localhost:3000

# 预期看到登录页面或Dashboard
```

### 6.3 验证Agent连接

```bash
# 查看后端日志
tail -f backend/logs/app.log

# 预期看到:
# [INFO] Received registration request from agent: xxx
# [INFO] Heartbeat received from agent: xxx
```

### 6.4 功能验证清单

- [ ] Agent能够注册到服务器
- [ ] Agent能够按间隔上报数据
- [ ] Web界面能够查看Agent列表
- [ ] Web界面能够查看Agent详情
- [ ] Web界面能够查看进程列表
- [ ] Web界面能够查看端口列表
- [ ] (Phase 2) 基线管理功能正常
- [ ] (Phase 2) 告警中心功能正常

---

## 7. 常见问题

### 7.1 数据库连接失败

**问题**: `Communications link failure`

**解决方案**:
```bash
# 1. 检查MySQL服务状态
docker ps | grep mysql

# 2. 检查MySQL日志
docker logs terminal-monitor-mysql

# 3. 检查连接配置
# 确认application.yml中的数据库地址、用户名、密码正确
```

### 7.2 Agent无法连接后端

**问题**: Agent启动后无法连接服务器

**解决方案**:
```bash
# 1. 检查后端服务是否运行
curl http://your-server:8080/api/health

# 2. 检查Agent配置中的server_url是否正确
cat config.json

# 3. 检查防火墙设置
# 确保8080端口已开放
```

### 7.3 端口被占用

**问题**: `Port 8080 was already in use`

**解决方案**:
```bash
# 1. 查看占用端口的进程
netstat -ano | findstr :8080

# 2. 停止占用端口的进程或修改配置
# 修改application.yml中的server.port为其他端口
```

### 7.4 前端编译错误

**问题**: `npm install` 或 `npm run dev` 报错

**解决方案**:
```bash
# 1. 删除node_modules重新安装
rm -rf node_modules
npm install

# 2. 检查Node.js版本
node -v

# 3. 清除npm缓存
npm cache clean --force
```

### 7.5 CORS跨域问题

**问题**: 前端API请求被阻止

**解决方案**:
```java
// 确保Controller添加了@CrossOrigin注解
@RestController
@RequestMapping("/api/agents")
@CrossOrigin(origins = "*")
public class AgentController {
    // ...
}
```

---

## 8. 运维管理

### 8.1 日志管理

#### 8.1.1 后端日志

```bash
# 默认日志位置
backend/logs/

# 使用Docker时查看日志
docker logs terminal-monitor-backend

# 实时日志
docker logs -f terminal-monitor-backend
```

#### 8.1.2 Agent日志

```bash
# 默认日志位置
agent/logs/

# Linux Systemd日志
journalctl -u terminal-monitor-agent -f
```

### 8.2 备份与恢复

#### 8.2.1 数据库备份

```bash
# 全量备份
mysqldump -u root -p terminal_monitor > backup_$(date +%Y%m%d).sql

# 备份并压缩
mysqldump -u root -p terminal_monitor | gzip > backup_$(date +%Y%m%d).sql.gz

# Docker方式备份
docker exec terminal-monitor-mysql mysqldump -u root -p terminal_monitor > backup.sql
```

#### 8.2.2 数据恢复

```bash
# 从备份恢复
mysql -u root -p terminal_monitor < backup_20260211.sql

# Docker方式恢复
docker exec -i terminal-monitor-mysql mysql -u root -p terminal_monitor < backup.sql
```

### 8.3 服务管理

#### 8.3.1 Docker Compose管理

```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 重启服务
docker-compose restart

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f

# 更新并重启
docker-compose up -d --build
```

#### 8.3.2 Systemd管理

```bash
# 启动服务
sudo systemctl start terminal-monitor-agent

# 停止服务
sudo systemctl stop terminal-monitor-agent

# 重启服务
sudo systemctl restart terminal-monitor-agent

# 查看状态
sudo systemctl status terminal-monitor-agent

# 设置开机自启
sudo systemctl enable terminal-monitor-agent
```

### 8.4 监控告警

#### 8.4.1 健康检查端点

```bash
# 后端健康检查
curl http://localhost:8080/actuator/health

# 或
curl http://localhost:8080/api/health
```

#### 8.4.2 监控指标

建议集成以下监控工具:
- **Prometheus**: 采集应用指标
- **Grafana**: 可视化监控面板
- **ELK Stack**: 日志收集和分析

### 8.5 性能优化

#### 8.5.1 数据库优化

```sql
-- 定期优化表
OPTIMIZE TABLE agents;
OPTIMIZE TABLE processes;
OPTIMIZE TABLE ports;

-- 分析表索引
ANALYZE TABLE agents;
ANALYZE TABLE processes;
```

#### 8.5.2 配置优化

```yaml
# application.yml 优化
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

### 8.6 扩容方案

#### 8.6.1 水平扩展后端

```yaml
# docker-compose.scale.yml
version: '3.8'

services:
  backend:
    build: ./backend
    deploy:
      replicas: 3
    depends_on:
      - mysql
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/terminal_monitor
    networks:
      - monitor-network

  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    depends_on:
      - backend
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - monitor-network

  mysql:
    # 使用外部MySQL或MySQL集群
```

#### 8.6.2 MySQL主从复制

```ini
# my.cnf (主库)
server-id=1
log_bin=mysql-bin
binlog_format=ROW

# my.cnf (从库)
server-id=2
relay_log=mysql-relay-bin
read_only=ON
```

---

## 9. 安全加固建议

### 9.1 网络安全

```bash
# 1. 配置防火墙
# UFW (Ubuntu)
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# 2. 使用HTTPS
# 配置SSL证书
server {
    listen 443 ssl;
    ssl_certificate /etc/ssl/certs/server.crt;
    ssl_certificate_key /etc/ssl/private/server.key;
}
```

### 9.2 数据库安全

```sql
-- 1. 创建专用数据库用户
CREATE USER 'monitor'@'%' IDENTIFIED BY 'strong_password';
GRANT ALL PRIVILEGES ON terminal_monitor.* TO 'monitor'@'%';
FLUSH PRIVILEGES;

-- 2. 定期更改密码
ALTER USER 'root'@'%' IDENTIFIED BY 'new_strong_password';
```

### 9.3 Agent认证增强

```python
# 在Agent中添加API Key认证
class DataReporter:
    def __init__(self, server_url, api_key=None):
        self.api_key = api_key
        self.headers = {'Authorization': f'Bearer {api_key}'} if api_key else {}
```

---

## 10. 故障排查清单

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 后端无法启动 | 数据库连接失败 | 检查MySQL服务 |
| Agent无法注册 | 服务器地址错误 | 检查config.json |
| Web无法访问 | 前端服务未运行 | 检查npm run dev |
| API请求超时 | 后端负载过高 | 检查服务器资源 |
| 数据不更新 | Agent采集异常 | 检查Agent日志 |
| 告警不触发 | 基线未创建 | 检查基线配置 |
