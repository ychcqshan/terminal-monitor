# 终端安全监控系统 - Phase 2 数据库设计文档

## 版本信息

| 项目 | 内容 |
|------|------|
| 版本号 | v1.0.0 |
| 文档版本 | 2.0 |
| 创建日期 | 2026-02-11 |
| 数据库 | MySQL 8.0+ |
| 状态 | 已完成 |

---

## 1. 数据库概览

### 1.1 数据库名

```
terminal_monitor
```

### 1.2 字符集和排序规则

```sql
CREATE DATABASE terminal_monitor
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;
```

### 1.3 ER图

```
┌─────────────────┐       ┌─────────────────┐
│ baseline_config │       │ baseline_snapshot│
├─────────────────┤       ├─────────────────┤
│ id (PK)         │◄──────│ config_id (FK)  │
│ agent_id        │       │ id (PK)         │
│ baseline_type   │       │ agent_id        │
│ status          │       │ baseline_type   │
│ learning_mode   │       │ snapshot_hash   │
│ learning_days   │       │ item_count      │
│ learn_start     │       │ valid_from      │
│ learn_end       │       └────────┬────────┘
│ created_type    │                │
│ source_agent_id │                │ 1:N
└─────────────────┘                │
                                    ▼
                           ┌─────────────────┐
                           │ baseline_item   │
                           ├─────────────────┤
                           │ id (PK)         │
                           │ snapshot_id (FK)│
                           │ item_key        │
                           │ item_value      │
                           │ item_type       │
                           │ item_hash       │
                           └─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│  security_alert │       │   alert_rule    │
├─────────────────┤       ├─────────────────┤
│ id (PK)         │       │ id (PK)         │
│ agent_id        │       │ rule_name       │
│ alert_type      │       │ rule_type       │
│ alert_level     │       │ rule_condition   │
│ alert_title     │       │ action_type      │
│ alert_content   │       │ alert_level      │
│ anomaly_type    │       │ enabled          │
│ alert_status    │       │ created_at       │
│ created_at      │       │ updated_at       │
└─────────────────┘       └─────────────────┘
```

---

## 2. 基线相关表

### 2.1 baseline_config（基线配置表）

#### 2.1.1 表结构

```sql
CREATE TABLE baseline_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    baseline_type VARCHAR(20) NOT NULL COMMENT '基线类型: PROCESS/PORT/USB/LOGIN/SOFTWARE',
    status VARCHAR(20) DEFAULT 'LEARNING' COMMENT '状态: LEARNING/ACTIVE',
    learning_mode VARCHAR(20) COMMENT '学习模式: QUICK/STANDARD/CUSTOM/MANUAL',
    learning_days INT COMMENT '学习天数',
    learn_start DATETIME COMMENT '学习开始时间',
    learn_end DATETIME COMMENT '学习结束时间',
    created_type VARCHAR(20) COMMENT '创建类型: LEARNING/IMPORT/COPY/MANUAL',
    source_agent_id VARCHAR(36) COMMENT '源Agent ID（复制创建时使用）',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_agent_type (agent_id, baseline_type),
    INDEX idx_agent_id (agent_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='基线配置表';
```

#### 2.1.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | 是 | AUTO | 主键 |
| agent_id | VARCHAR(36) | 是 | - | Agent唯一标识 |
| baseline_type | VARCHAR(20) | 是 | - | 基线类型枚举 |
| status | VARCHAR(20) | 否 | LEARNING | 学习状态 |
| learning_mode | VARCHAR(20) | 否 | - | 学习模式 |
| learning_days | INT | 否 | - | 学习天数 |
| learn_start | DATETIME | 否 | - | 学习开始时间 |
| learn_end | DATETIME | 否 | - | 学习结束时间 |
| created_type | VARCHAR(20) | 否 | - | 创建方式 |
| source_agent_id | VARCHAR(36) | 否 | - | 源Agent ID |
| created_at | DATETIME | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | 否 | CURRENT_TIMESTAMP | 更新时间 |

#### 2.1.3 枚举值

| 字段 | 可选值 |
|------|--------|
| baseline_type | PROCESS, PORT, USB, LOGIN, SOFTWARE |
| status | LEARNING, ACTIVE |
| learning_mode | QUICK, STANDARD, CUSTOM, MANUAL |
| created_type | LEARNING, IMPORT, COPY, MANUAL |

---

### 2.2 baseline_snapshot（基线快照表）

#### 2.2.1 表结构

```sql
CREATE TABLE baseline_snapshot (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    baseline_type VARCHAR(20) NOT NULL COMMENT '基线类型',
    config_id BIGINT COMMENT '配置ID',
    snapshot_hash VARCHAR(64) COMMENT '快照哈希值',
    item_count INT DEFAULT 0 COMMENT '项目数量',
    valid_from DATETIME COMMENT '生效时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_agent_type (agent_id, baseline_type),
    INDEX idx_created_at (created_at),
    CONSTRAINT fk_snapshot_config FOREIGN KEY (config_id)
        REFERENCES baseline_config(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='基线快照表';
```

#### 2.2.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | 是 | AUTO | 主键 |
| agent_id | VARCHAR(36) | 是 | - | Agent唯一标识 |
| baseline_type | VARCHAR(20) | 是 | - | 基线类型 |
| config_id | BIGINT | 否 | - | 外键，关联baseline_config |
| snapshot_hash | VARCHAR(64) | 否 | - | SHA-256哈希值 |
| item_count | INT | 否 | 0 | 项目数量 |
| valid_from | DATETIME | 否 | - | 生效时间 |
| created_at | DATETIME | 否 | CURRENT_TIMESTAMP | 创建时间 |

---

### 2.3 baseline_item（基线项目表）

#### 2.3.1 表结构

```sql
CREATE TABLE baseline_item (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    snapshot_id BIGINT NOT NULL COMMENT '快照ID',
    item_key VARCHAR(255) NOT NULL COMMENT '项目键',
    item_value TEXT COMMENT '项目值',
    item_type VARCHAR(50) COMMENT '项目类型',
    item_hash VARCHAR(64) COMMENT '项目哈希值',
    INDEX idx_snapshot (snapshot_id),
    INDEX idx_item_key (item_key(100)),
    CONSTRAINT fk_item_snapshot FOREIGN KEY (snapshot_id)
        REFERENCES baseline_snapshot(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='基线项目表';
```

#### 2.3.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | 是 | AUTO | 主键 |
| snapshot_id | BIGINT | 是 | - | 外键，关联baseline_snapshot |
| item_key | VARCHAR(255) | 是 | - | 项目唯一键 |
| item_value | TEXT | 否 | - | 项目值 |
| item_type | VARCHAR(50) | 否 | - | 项目类型 |
| item_hash | VARCHAR(64) | 否 | - | SHA-256哈希值 |

#### 2.3.3 数据示例

| snapshot_id | item_key | item_value | item_type |
|-------------|----------|------------|-----------|
| 1 | nginx:80 | 80\|tcp\|LISTEN\|nginx | port |
| 1 | sshd:22 | 22\|tcp\|LISTEN\|sshd | port |
| 2 | chrome:1234 | chrome\|1234\|5.0\|2.5 | process |

---

## 3. 告警相关表

### 3.1 security_alert（安全告警表）

#### 3.1.1 表结构

```sql
CREATE TABLE security_alert (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL COMMENT 'Agent ID',
    alert_type VARCHAR(50) NOT NULL COMMENT '告警类型',
    alert_level VARCHAR(20) NOT NULL COMMENT '告警级别',
    alert_title VARCHAR(200) NOT NULL COMMENT '告警标题',
    alert_content TEXT COMMENT '告警内容',
    anomaly_type VARCHAR(50) COMMENT '异常类型: NEW/MISSING/MODIFIED',
    baseline_item JSON COMMENT '基线项目数据',
    current_item JSON COMMENT '当前项目数据',
    alert_status VARCHAR(20) DEFAULT 'NEW' COMMENT '告警状态',
    acknowledged_by VARCHAR(100) COMMENT '确认人',
    acknowledged_at DATETIME COMMENT '确认时间',
    resolved_by VARCHAR(100) COMMENT '解决人',
    resolved_at DATETIME COMMENT '解决时间',
    resolution_note TEXT COMMENT '解决备注',
    ignored_by VARCHAR(100) COMMENT '忽略人',
    ignored_at DATETIME COMMENT '忽略时间',
    ignore_reason TEXT COMMENT '忽略原因',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_agent_id (agent_id),
    INDEX idx_alert_status (alert_status),
    INDEX idx_alert_level (alert_level),
    INDEX idx_created_at (created_at),
    INDEX idx_agent_status (agent_id, alert_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='安全告警表';
```

#### 3.1.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | 是 | AUTO | 主键 |
| agent_id | VARCHAR(36) | 是 | - | Agent唯一标识 |
| alert_type | VARCHAR(50) | 是 | - | 告警类型枚举 |
| alert_level | VARCHAR(20) | 是 | - | 告警级别 |
| alert_title | VARCHAR(200) | 是 | - | 告警标题 |
| alert_content | TEXT | 否 | - | 告警详细内容 |
| anomaly_type | VARCHAR(50) | 否 | - | 异常类型 |
| baseline_item | JSON | 否 | - | 基线JSON数据 |
| current_item | JSON | 否 | - | 当前数据JSON |
| alert_status | VARCHAR(20) | 否 | NEW | 告警状态 |
| acknowledged_by | VARCHAR(100) | 否 | - | 确认人 |
| acknowledged_at | DATETIME | 否 | - | 确认时间 |
| resolved_by | VARCHAR(100) | 否 | - | 解决人 |
| resolved_at | DATETIME | 否 | - | 解决时间 |
| resolution_note | TEXT | 否 | - | 解决备注 |
| ignored_by | VARCHAR(100) | 否 | - | 忽略人 |
| ignored_at | DATETIME | 否 | - | 忽略时间 |
| ignore_reason | TEXT | 否 | - | 忽略原因 |
| created_at | DATETIME | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | 否 | CURRENT_TIMESTAMP | 更新时间 |

#### 3.1.3 枚举值

| 字段 | 可选值 |
|------|--------|
| alert_type | PROCESS, PORT, USB, LOGIN, SOFTWARE, SYSTEM |
| alert_level | CRITICAL, HIGH, MEDIUM, LOW |
| anomaly_type | NEW, MISSING, MODIFIED |
| alert_status | NEW, ACKNOWLEDGED, RESOLVED, IGNORED |

#### 3.1.4 数据示例

| agent_id | alert_type | alert_level | alert_title | alert_status |
|----------|------------|-------------|-------------|--------------|
| xxx-xxx | PROCESS | HIGH | 发现未知进程suspicious | NEW |
| xxx-xxx | PORT | CRITICAL | 发现异常开放端口9999 | ACKNOWLEDGED |
| xxx-xxx | USB | MEDIUM | 新USB设备插入 | RESOLVED |

---

### 3.2 alert_rule（告警规则表）

#### 3.2.1 表结构

```sql
CREATE TABLE alert_rule (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL COMMENT '规则名称',
    rule_type VARCHAR(50) NOT NULL COMMENT '规则类型',
    rule_condition VARCHAR(500) NOT NULL COMMENT '规则条件',
    action_type VARCHAR(50) DEFAULT 'ALERT' COMMENT '动作类型',
    alert_level VARCHAR(20) DEFAULT 'MEDIUM' COMMENT '告警级别',
    enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_rule_type (rule_type),
    INDEX idx_enabled (enabled),
    UNIQUE KEY uk_rule_name (rule_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警规则表';
```

#### 3.2.2 字段说明

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | 是 | AUTO | 主键 |
| rule_name | VARCHAR(100) | 是 | - | 规则唯一名称 |
| rule_type | VARCHAR(50) | 是 | - | 规则类型 |
| rule_condition | VARCHAR(500) | 是 | - | 条件表达式 |
| action_type | VARCHAR(50) | 否 | ALERT | 触发动作 |
| alert_level | VARCHAR(20) | 否 | MEDIUM | 默认告警级别 |
| enabled | BOOLEAN | 否 | TRUE | 是否启用 |
| created_at | DATETIME | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | 否 | CURRENT_TIMESTAMP | 更新时间 |

#### 3.2.3 枚举值

| 字段 | 可选值 |
|------|--------|
| rule_type | PROCESS, PORT, USB, LOGIN, SOFTWARE, SYSTEM |
| action_type | ALERT, BLOCK, NOTIFY |
| alert_level | CRITICAL, HIGH, MEDIUM, LOW |

#### 3.2.4 规则示例

| rule_name | rule_type | rule_condition | alert_level |
|-----------|-----------|----------------|-------------|
| 检测高危端口 | PORT | port >= 8000 && port <= 9000 | HIGH |
| 未知进程检测 | PROCESS | name NOT IN (nginx,sshd,chrome) | MEDIUM |
| 重复登录检测 | LOGIN | login_count > 3 | LOW |

---

## 4. 现有数据表（参考）

### 4.1 agent（Agent信息表）

```sql
CREATE TABLE agent (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100),
    status VARCHAR(20) DEFAULT 'offline',
    platform VARCHAR(50),
    hostname VARCHAR(100),
    ip_address VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_heartbeat DATETIME,
    version VARCHAR(20)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Agent信息表';
```

### 4.2 process_info（进程信息表）

```sql
CREATE TABLE process_info (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL,
    pid INT NOT NULL,
    name VARCHAR(200),
    cpu_percent DECIMAL(5,2),
    memory_percent DECIMAL(5,2),
    status VARCHAR(20),
    collected_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_agent_collected (agent_id, collected_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='进程信息表';
```

### 4.3 port_info（端口信息表）

```sql
CREATE TABLE port_info (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agent_id VARCHAR(36) NOT NULL,
    port INT NOT NULL,
    protocol VARCHAR(10),
    status VARCHAR(20),
    process_name VARCHAR(200),
    collected_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_agent_collected (agent_id, collected_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='端口信息表';
```

---

## 5. 数据库操作

### 5.1 初始化脚本

```sql
-- 创建数据库
CREATE DATABASE terminal_monitor
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE terminal_monitor;

-- 创建表（按依赖顺序）
CREATE TABLE agent (...);
CREATE TABLE baseline_config (...);
CREATE TABLE baseline_snapshot (...);
CREATE TABLE baseline_item (...);
CREATE TABLE security_alert (...);
CREATE TABLE alert_rule (...);
CREATE TABLE process_info (...);
CREATE TABLE port_info (...);
-- ... 其他表
```

### 5.2 常用查询

#### 5.2.1 查询Agent的活跃基线

```sql
SELECT * FROM baseline_config
WHERE agent_id = 'xxx-xxx'
  AND status = 'ACTIVE';
```

#### 5.2.2 查询Agent的待处理告警数量

```sql
SELECT COUNT(*) FROM security_alert
WHERE agent_id = 'xxx-xxx'
  AND alert_status = 'NEW';
```

#### 5.2.3 查询严重未解决告警

```sql
SELECT * FROM security_alert
WHERE alert_level = 'CRITICAL'
  AND alert_status != 'RESOLVED'
ORDER BY created_at DESC;
```

#### 5.2.4 查询基线对比结果

```sql
-- 新增项目（在当前数据中但不在基线中）
SELECT current.*
FROM process_info current
LEFT JOIN baseline_snapshot snapshot ON snapshot.agent_id = current.agent_id
LEFT JOIN baseline_item item ON item.snapshot_id = snapshot.id
WHERE snapshot.agent_id = 'xxx-xxx'
  AND snapshot.baseline_type = 'PROCESS'
  AND item.id IS NULL;
```

### 5.3 数据清理策略

#### 5.3.1 清理历史告警（保留90天）

```sql
DELETE FROM security_alert
WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

#### 5.3.2 清理旧基线快照（保留最新5个）

```sql
DELETE FROM baseline_item
WHERE snapshot_id IN (
    SELECT id FROM (
        SELECT id FROM baseline_snapshot
        WHERE agent_id = 'xxx-xxx'
          AND baseline_type = 'PROCESS'
        ORDER BY created_at DESC
        LIMIT 5 OFFSET 5
    ) old_snapshots
);

DELETE FROM baseline_snapshot
WHERE agent_id = 'xxx-xxx'
  AND baseline_type = 'PROCESS'
  AND id NOT IN (
      SELECT id FROM (
          SELECT id FROM baseline_snapshot
          WHERE agent_id = 'xxx-xxx'
            AND baseline_type = 'PROCESS'
          ORDER BY created_at DESC
          LIMIT 5
      ) recent
  );
```

---

## 6. 性能优化建议

### 6.1 索引优化

| 表名 | 索引字段 | 索引类型 | 说明 |
|------|----------|----------|------|
| baseline_config | agent_id, baseline_type | UNIQUE | 唯一约束 |
| baseline_config | status | INDEX | 状态筛选 |
| baseline_snapshot | agent_id, baseline_type | INDEX | 复合索引 |
| baseline_item | snapshot_id | INDEX | 外键索引 |
| security_alert | agent_id, alert_status | INDEX | 复合索引 |
| security_alert | alert_level, alert_status | INDEX | 告警统计 |

### 6.2 分区策略

```sql
-- 按时间分区告警表
ALTER TABLE security_alert
PARTITION BY RANGE (TO_DAYS(created_at)) (
    PARTITION p_2026_01 VALUES LESS THAN (TO_DAYS('2026-02-01')),
    PARTITION p_2026_02 VALUES LESS THAN (TO_DAYS('2026-03-01')),
    PARTITION p_2026_03 VALUES LESS THAN (TO_DAYS('2026-04-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 6.3 查询优化

- 避免SELECT *，只查询必要字段
- 使用分页查询限制结果集
- 定期分析表优化索引
- 使用EXPLAIN分析执行计划

---

## 7. 备份恢复

### 7.1 备份策略

```bash
# 每日全量备份
mysqldump -u root -p terminal_monitor > backup_$(date +%Y%m%d).sql

# 增量备份（需要开启binlog）
mysqlbinlog --start-datetime='2026-02-11 00:00:00' mysql-bin.000001 > incremental_backup.sql
```

### 7.2 恢复策略

```bash
# 全量恢复
mysql -u root -p terminal_monitor < backup_20260211.sql

# 恢复到指定时间点
mysql -u root -p terminal_monitor < backup_full.sql
mysql -u root -p terminal_monitor < incremental_backup.sql
```
